# Flujo de Suscripci√≥n - Documentaci√≥n Visual

## üìä Estados de Suscripci√≥n

### Estado 1: Usuario Free
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Suscripci√≥n                             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Plan actual              Gratis         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ   üëë Actualizar a Pro               ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acciones disponibles:**
- ‚úÖ Actualizar a Pro ‚Üí redirige a `/upgrade`

---

### Estado 2: Usuario Pro Activo
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Suscripci√≥n                             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Plan actual              üëë Pro         ‚îÇ
‚îÇ Pr√≥xima renovaci√≥n       15 de febrero  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Administrar suscripci√≥n         ‚Üó   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ         Cancelar suscripci√≥n            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acciones disponibles:**
- ‚úÖ Administrar suscripci√≥n ‚Üí abre portal de Polar
- ‚úÖ Cancelar suscripci√≥n ‚Üí abre di√°logo de confirmaci√≥n

**UserMenu muestra:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Plan                     ‚îÇ
‚îÇ üëë Pro                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### Estado 3: Usuario Pro Cancelado ‚≠ê NUEVO
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Suscripci√≥n                             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ Plan actual        üëë Pro (Cancelado)   ‚îÇ
‚îÇ Acceso Pro hasta         15 de febrero  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ   üëë Renovar suscripci√≥n            ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Ver historial de facturaci√≥n    ‚Üó   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acciones disponibles:**
- ‚úÖ Renovar suscripci√≥n ‚Üí redirige a `/upgrade` para nueva suscripci√≥n
- ‚úÖ Ver historial de facturaci√≥n ‚Üí abre portal de Polar (solo lectura)
- ‚ùå NO puede cancelar (ya est√° cancelado)

**UserMenu muestra:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Plan                     ‚îÇ
‚îÇ üëë Pro (Cancelado)       ‚îÇ ‚Üê Clickeable, va a /upgrade
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ Flujo Completo de Cancelaci√≥n y Renovaci√≥n

### Paso 1: Usuario Pro Activo ‚Üí Cancela
```
Usuario Pro Activo
       ‚Üì
Clic en "Cancelar suscripci√≥n"
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ¬øCancelar suscripci√≥n Pro?                  ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Tu suscripci√≥n se cancelar√°, pero seguir√°s  ‚îÇ
‚îÇ teniendo acceso hasta el 15 de febrero.     ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ [Mantener] [Cancelar suscripci√≥n]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì Confirma
API: POST /api/subscription/cancel
  - polarClient.subscriptions.revoke()
  - UPDATE subscriptions SET status='canceled'
       ‚Üì
‚úÖ Toast: "Suscripci√≥n cancelada correctamente"
       ‚Üì
Usuario Pro Cancelado
```

### Paso 2: Usuario Pro Cancelado ‚Üí Renueva
```
Usuario Pro Cancelado
       ‚Üì
Clic en "Renovar suscripci√≥n"
       ‚Üì
Redirige a /upgrade
       ‚Üì
Selecciona plan Pro
       ‚Üì
Checkout de Polar
       ‚Üì
Pago exitoso
       ‚Üì
Webhook de Polar
  - UPDATE subscriptions SET status='active'
       ‚Üì
‚úÖ Usuario Pro Activo nuevamente
```

---

## üéØ L√≥gica de Negocio

### Determinaci√≥n del Estado

```typescript
const isPro = subscription?.status === "active";
const isCanceled = subscription?.status === "canceled";

// Usuario tiene acceso Pro si:
// 1. Est√° activo, O
// 2. Est√° cancelado pero a√∫n dentro del periodo pagado
const hasProAccess = 
  subscription?.status === "active" || 
  (subscription?.status === "canceled" && 
   subscription.current_period_end && 
   new Date(subscription.current_period_end) > new Date());
```

### Acciones Permitidas por Estado

| Estado | Actualizar | Administrar | Cancelar | Renovar |
|--------|-----------|-------------|----------|---------|
| `free` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `active` | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå |
| `canceled` | ‚ùå | ‚úÖ (solo lectura) | ‚ùå | ‚úÖ |

---

## üì± Experiencia de Usuario

### Escenario 1: Cancelar por Error
**Problema:** Usuario cancela pero se arrepiente inmediatamente.

**Soluci√≥n:** 
- ‚úÖ Puede renovar inmediatamente desde `/profile`
- ‚úÖ Bot√≥n prominente "Renovar suscripci√≥n"
- ‚úÖ Mantiene acceso hasta fin del periodo

### Escenario 2: Cancelar y Volver Despu√©s
**Problema:** Usuario cancela en febrero, quiere volver en marzo.

**Flujo:**
1. Cancela en febrero ‚Üí status: `canceled`
2. Mantiene acceso hasta 28 de febrero
3. Desde 1 de marzo ‚Üí vuelve a `free`
4. Ve bot√≥n "Actualizar a Pro"
5. Puede suscribirse nuevamente

### Escenario 3: Cambiar de Opini√≥n Durante el Periodo
**Problema:** Usuario cancela pero cambia de opini√≥n antes de que expire.

**Flujo:**
1. Cancela el 5 de febrero (expira el 28)
2. El 10 de febrero ve "Renovar suscripci√≥n"
3. Hace clic ‚Üí va a `/upgrade`
4. Compra nuevo plan Pro
5. Nueva suscripci√≥n comienza (puede ser inmediata o al fin del periodo actual)

---

## üîß Implementaci√≥n T√©cnica

### Componentes Involucrados

```
app/(dashboard)/(routes)/profile/page.tsx
  ‚îú‚îÄ‚îÄ Determina estados: isPro, isCanceled
  ‚îú‚îÄ‚îÄ Renderiza botones seg√∫n estado
  ‚îî‚îÄ‚îÄ Pasa props a CancelSubscription

components/modules/profile/cancel-subscription.tsx
  ‚îú‚îÄ‚îÄ Di√°logo de confirmaci√≥n
  ‚îú‚îÄ‚îÄ Llama a POST /api/subscription/cancel
  ‚îî‚îÄ‚îÄ Maneja loading y errores

app/api/subscription/cancel/route.ts
  ‚îú‚îÄ‚îÄ Verifica autenticaci√≥n
  ‚îú‚îÄ‚îÄ Valida pertenencia de suscripci√≥n
  ‚îú‚îÄ‚îÄ polarClient.subscriptions.revoke()
  ‚îî‚îÄ‚îÄ UPDATE Supabase ‚Üí status: 'canceled'
```

### Base de Datos

```sql
-- Estado de suscripci√≥n en Supabase
Table: subscriptions
Columns:
  - status: 'free' | 'active' | 'canceled' | 'past_due'
  - current_period_end: timestamp (importante para cancelados)
  - polar_subscription_id: text (necesario para renovar)
  - polar_customer_id: text (necesario para portal)
```

---

## üé® UI/UX Decisiones de Dise√±o

### Por qu√© "Renovar" en lugar de "Reactivar"

‚úÖ **"Renovar suscripci√≥n"**
- M√°s familiar para usuarios
- Implica nuevo periodo de pago
- Consistente con "Actualizar a Pro"

‚ùå **"Reactivar suscripci√≥n"**
- Podr√≠a confundir (¬øreactiva la actual o crea nueva?)
- Menos com√∫n en SaaS

### Por qu√© mostrar "Ver historial de facturaci√≥n"

‚úÖ **Beneficios:**
- Usuario cancelado puede revisar facturas pasadas
- Acceso al portal de Polar en modo lectura
- Transparencia total

### Por qu√© mantener acceso hasta fin del periodo

‚úÖ **Razones:**
- Usuario ya pag√≥ por ese periodo
- Pr√°ctica est√°ndar en SaaS (Stripe, Paddle, Polar)
- Evita sensaci√≥n de "me robaron"
- Da tiempo para cambiar de opini√≥n

---

## üìä M√©tricas Sugeridas

### Tracking de Cancelaciones

```typescript
// Eventos a trackear:
- "subscription_cancel_clicked" // Usuario abre di√°logo
- "subscription_cancel_confirmed" // Confirm√≥ cancelaci√≥n
- "subscription_cancel_abandoned" // Cerr√≥ di√°logo sin confirmar
- "subscription_renew_clicked" // Cancelado quiere renovar
```

### Tasa de Reactivaci√≥n

```
Reactivaci√≥n = (Renovaciones despu√©s de cancelar) / (Total cancelaciones)
```

Si esta m√©trica es alta (>20%), significa que:
- ‚úÖ El proceso de renovaci√≥n es efectivo
- ‚úÖ Los usuarios aprecian mantener acceso hasta fin de periodo

---

## üöÄ Pr√≥ximas Mejoras

### Corto Plazo
- [ ] Email de confirmaci√≥n de cancelaci√≥n
- [ ] Recordatorio antes de que expire el periodo
- [ ] Descuento de "reactivaci√≥n" para usuarios cancelados

### Largo Plazo
- [ ] Pausar suscripci√≥n (1-3 meses)
- [ ] Cambiar entre planes sin cancelar
- [ ] Programa de retenci√≥n (oferta antes de cancelar)

---

**Versi√≥n:** 1.0.0  
**Fecha:** 30 de Enero, 2025  
**Estado:** ‚úÖ Implementado y Funcionando